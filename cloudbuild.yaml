steps:
  # Step 1: Install dependencies
  - name: node:20
    entrypoint: npm
    args: ["ci"]
    id: install

  # Step 2: Run tests (connection validation)
  - name: node:20
    entrypoint: npm
    args: ["test"]
    id: test
    waitFor: ["install"]
    env:
      - 'DB_HOST=/cloudsql/enhanced-oasis-481009-n3:us-central1:new-instance1'
      - 'DB_USER=dbuser'
      - 'DB_NAME=clientdb'
      - 'DB_PASSWORD_SECRET=db-password'
      - 'GOOGLE_CLOUD_PROJECT=enhanced-oasis-481009-n3'

  # Step 3: Run database migrations
  - name: node:20
    entrypoint: npm
    args: ["run", "migrate"]
    id: migrate
    waitFor: ["test"]
    env:
      - 'DB_HOST=/cloudsql/enhanced-oasis-481009-n3:us-central1:new-instance1'
      - 'DB_USER=dbuser'
      - 'DB_NAME=clientdb'
      - 'DB_PASSWORD_SECRET=db-password'
      - 'GOOGLE_CLOUD_PROJECT=enhanced-oasis-481009-n3'

  # Step 4: Deploy to App Engine
  - name: gcr.io/cloud-builders/gcloud
    args: ["app", "deploy", "app.yaml", "--quiet"]
    id: deploy
    waitFor: ["migrate"]

timeout: "1200s"

options:
  logging: CLOUD_LOGGING_ONLY

# Service account permissions required:
# - roles/secretmanager.secretAccessor (for accessing db-password secret)
# - roles/appengine.appAdmin (for deploying to App Engine)
# - roles/cloudsql.client (for Cloud SQL connection)
